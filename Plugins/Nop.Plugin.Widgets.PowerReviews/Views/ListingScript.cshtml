@using Nop.Plugin.Widgets.PowerReviews;
@using Nop.Plugin.Widgets.PowerReviews.Models;
@using Nop.Core;

@model ListingScriptModel

@{
    Html.AddHeadCustomParts("<script src=\"https://ui.powerreviews.com/stable/4.1/ui.js\" async></script>");
    Html.AddCssFileParts("~/Plugins/Misc.AbcFrontend/styles/power-reviews-listing.css");
}

<script>
	var currentlyDisplayedPrSnippets = [];

	$(document).ajaxComplete(function () {
		updatePowerReviewsCategorySnippets()
	});

	function updatePowerReviewsCategorySnippets() {
		var productGrid = $('.product-grid');
		if (productGrid.length == 0 || productGrid.is(":hidden")) {	return;	}

		var itemBoxes = productGrid.find('.item-box');
		if (itemBoxes.length == 0) { return; }

		var prSnippets = itemBoxes.find("[id^='pr_snippet_product_']");
		if (areArraysEqual(prSnippets, currentlyDisplayedPrSnippets)) {	return;	}

		currentlyDisplayedPrSnippets = prSnippets;

		var powerReviewsRenderConfigs = [];
		@foreach(var product in Model.FeedlessProducts)
		{
			<text>
				powerReviewsRenderConfigs.push({
					page_id: '@product.Sku',
					api_key: "@Model.Settings.APIKey",
					locale: "en_US",
					merchant_group_id: "@Model.Settings.MerchantGroupId",
					merchant_id: "@Model.Settings.MerchantId",
					review_wrapper_url: `/write-a-review?pr_page_id={sku}`,
					ENABLE_CLIENT_SIDE_STRUCTURED_DATA: false,
					product:{
						name: '@product.feedlessProduct.Name',
						url: '@product.feedlessProduct.Url',
						image_url: '@product.feedlessProduct.ImageUrl',
						description: '@product.feedlessProduct.Description',
						category_name: '@product.feedlessProduct.CategoryName',
						manufacturer_id: '@product.feedlessProduct.ManufacturerId',
						upc: '@product.feedlessProduct.Upc',
						brand_name: '@product.feedlessProduct.BrandName',
						price: '@product.feedlessProduct.Price',
						in_stock: '@product.feedlessProduct.InStock'
					},
					components: {
						CategorySnippet: 'pr_snippet_product_@product.Id'
					}
				});
			</text>
		}	

		window.pwr = window.pwr || function () {
			(pwr.q = pwr.q || []).push(arguments); 
		};
		pwr("render", powerReviewsRenderConfigs);
	}

    function areArraysEqual(a1, a2) {
		if (a1.length !== a2.length) {
			return false;
		}
		for (var i = a1.length; i--;) {
			if (a1[i] !== a2[i]) {
				return false;
			}
		}
		return true;
	}
</script>